```
def window_partition(x, window_size):
    """
    Args:
        x: (B, H, W, C)
        window_size (int): window size - 通常默认 wh = ww = w = 4
    Returns:
        windows: (num_windows*B, window_size, window_size, C)
    """
    # (B, H, W, C) -> (B, H//wh, wh, W//ww, ww, C) -> (B, H//wh, W//ww, wh, ww, C) -> ((B*H*W)//(wh*ww), wh, ww, C)
    B, H, W, C = x.shape
    #print(x.shape)
    x = x.view(B, H // window_size, window_size, W // window_size, window_size, C)
    #print(x.shape)
    windows = x.permute(0, 1, 3, 2, 4, 5).contiguous().view(-1, window_size, window_size, C)
    return windows  # ((B*H*W)//(wh*ww), wh, ww, C) = (N, wh, ww, C)
 
 
def window_reverse(windows, window_size, H, W):
    """
    Args:
        windows: (num_windows*B, window_size, window_size, C)
        window_size (int): Window size - 通常默认 wh = ww = w = 4
        H (int): Height of image
        W (int): Width of image
    Returns:
        x: (B, H, W, C)
    """
    # ((B*H*W)//(wh*ww), w, w, C) -> (B, H//wh, W//ww, wh, ww, C) -> (B, H//wh, wh, W//ww, ww, C) -> (B, H, W, C)
    B = int(windows.shape[0] / (H * W / window_size / window_size))
    x = windows.view(B, H // window_size, W // window_size, window_size, window_size, -1)
    x = x.permute(0, 1, 3, 2, 4, 5).contiguous().view(B, H, W, -1)
    return x
```

```
batch_size = 1
num_channel = 3
input_resolution = (8, 8)
image = torch.rand(batch_size, num_channel, input_resolution[0], input_resolution[1])
image.shape
```

```
torch.Size([1, 3, 8, 8])
```

---

```
# local window 的 size 完全由 window_size 和 shift_size 两种长度的组合构成
window_size = 4
shift_size = window_size // 2  # 2
 
# calculate attention mask for SW-MSA
H, W = input_resolution
img_mask = torch.zeros((1, H, W, 1))  # (1, H, W, 1)
 
# local window index range 
h_slices = (slice(0, -window_size),
            slice(-window_size, -shift_size),
            slice(-shift_size, None))
w_slices = (slice(0, -window_size),
            slice(-window_size, -shift_size),
            slice(-shift_size, None))
 
# 按 local window 标记 idx (即 cnt)
idx = 0
for h in h_slices:
    for w in w_slices:
        print(h, w, idx)  
        img_mask[:, h, w, :] = idx
        idx += 1
        
print(f"num local windows: {idx}")
img_mask.shape, img_mask[0, ..., 0]
```

```
slice(0, -4, None) slice(0, -4, None) 0
slice(0, -4, None) slice(-4, -2, None) 1
slice(0, -4, None) slice(-2, None, None) 2
slice(-4, -2, None) slice(0, -4, None) 3
slice(-4, -2, None) slice(-4, -2, None) 4
slice(-4, -2, None) slice(-2, None, None) 5
slice(-2, None, None) slice(0, -4, None) 6
slice(-2, None, None) slice(-4, -2, None) 7
slice(-2, None, None) slice(-2, None, None) 8
num local windows: 9
 
(torch.Size([1, 8, 8, 1]),
 tensor([[0., 0., 0., 0., 1., 1., 2., 2.],
         [0., 0., 0., 0., 1., 1., 2., 2.],
         [0., 0., 0., 0., 1., 1., 2., 2.],
         [0., 0., 0., 0., 1., 1., 2., 2.],
         [3., 3., 3., 3., 4., 4., 5., 5.],
         [3., 3., 3., 3., 4., 4., 5., 5.],
         [6., 6., 6., 6., 7., 7., 8., 8.],
         [6., 6., 6., 6., 7., 7., 8., 8.]]))
```

---

```
# (1, 8, 8, 1) = (1, H, W, 1) = (B, H, W, C)  ->  ((B*H*W)//(wh*ww), wh, ww, C) = (N, wh, ww, C) = (4, 4, 4, 1)
mask_windows = window_partition(img_mask, window_size) 
mask_windows.shape, mask_windows[..., 0]
```

```
(torch.Size([4, 4, 4, 1]),
 tensor([[[0., 0., 0., 0.],
          [0., 0., 0., 0.],
          [0., 0., 0., 0.],
          [0., 0., 0., 0.]],
 
         [[1., 1., 2., 2.],
          [1., 1., 2., 2.],
          [1., 1., 2., 2.],
          [1., 1., 2., 2.]],
 
         [[3., 3., 3., 3.],
          [3., 3., 3., 3.],
          [6., 6., 6., 6.],
          [6., 6., 6., 6.]],
 
         [[4., 4., 5., 5.],
          [4., 4., 5., 5.],
          [7., 7., 8., 8.],
          [7., 7., 8., 8.]]]))
```

---

```
mask_windows = mask_windows.view(-1, window_size * window_size)
mask_windows.shape, mask_windows
```

```
(torch.Size([4, 16]),
 tensor([[0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
         [1., 1., 2., 2., 1., 1., 2., 2., 1., 1., 2., 2., 1., 1., 2., 2.],
         [3., 3., 3., 3., 3., 3., 3., 3., 6., 6., 6., 6., 6., 6., 6., 6.],
         [4., 4., 5., 5., 4., 4., 5., 5., 7., 7., 8., 8., 7., 7., 8., 8.]]))
```

---

```
attn_mask = mask_windows.unsqueeze(1) - mask_windows.unsqueeze(2)
attn_mask.shape, attn_mask[..., 0]
```

```
(torch.Size([4, 4, 4, 4, 1]),
 tensor([[[[ 0.,  0.,  0.,  0.],
           [ 0.,  0.,  0.,  0.],
           [ 0.,  0.,  0.,  0.],
           [ 0.,  0.,  0.,  0.]],
 
          [[ 0.,  0.,  0.,  0.],
           [ 0.,  0.,  0.,  0.],
           [ 0.,  0.,  0.,  0.],
           [ 0.,  0.,  0.,  0.]],
 
          [[ 0.,  0.,  0.,  0.],
           [ 0.,  0.,  0.,  0.],
           [ 0.,  0.,  0.,  0.],
           [ 0.,  0.,  0.,  0.]],
 
          [[ 0.,  0.,  0.,  0.],
           [ 0.,  0.,  0.,  0.],
           [ 0.,  0.,  0.,  0.],
           [ 0.,  0.,  0.,  0.]]],
 
 
         [[[ 0.,  0.,  0.,  0.],
           [ 0.,  0.,  0.,  0.],
           [ 0.,  0.,  0.,  0.],
           [ 0.,  0.,  0.,  0.]],
 
          [[ 0.,  0.,  0.,  0.],
           [ 0.,  0.,  0.,  0.],
           [ 0.,  0.,  0.,  0.],
           [ 0.,  0.,  0.,  0.]],
 
          [[ 0.,  0.,  0.,  0.],
           [ 0.,  0.,  0.,  0.],
           [ 0.,  0.,  0.,  0.],
           [ 0.,  0.,  0.,  0.]],
 
          [[ 0.,  0.,  0.,  0.],
           [ 0.,  0.,  0.,  0.],
           [ 0.,  0.,  0.,  0.],
           [ 0.,  0.,  0.,  0.]]],
 
 
         [[[ 0.,  0.,  0.,  0.],
           [ 0.,  0.,  0.,  0.],
           [ 3.,  3.,  3.,  3.],
           [ 3.,  3.,  3.,  3.]],
 
          [[ 0.,  0.,  0.,  0.],
           [ 0.,  0.,  0.,  0.],
           [ 3.,  3.,  3.,  3.],
           [ 3.,  3.,  3.,  3.]],
 
          [[-3., -3., -3., -3.],
           [-3., -3., -3., -3.],
           [ 0.,  0.,  0.,  0.],
           [ 0.,  0.,  0.,  0.]],
 
          [[-3., -3., -3., -3.],
           [-3., -3., -3., -3.],
           [ 0.,  0.,  0.,  0.],
           [ 0.,  0.,  0.,  0.]]],
 
 
         [[[ 0.,  0.,  0.,  0.],
           [ 0.,  0.,  0.,  0.],
           [ 3.,  3.,  3.,  3.],
           [ 3.,  3.,  3.,  3.]],
 
          [[ 0.,  0.,  0.,  0.],
           [ 0.,  0.,  0.,  0.],
           [ 3.,  3.,  3.,  3.],
           [ 3.,  3.,  3.,  3.]],
 
          [[-3., -3., -3., -3.],
           [-3., -3., -3., -3.],
           [ 0.,  0.,  0.,  0.],
           [ 0.,  0.,  0.,  0.]],
 
          [[-3., -3., -3., -3.],
           [-3., -3., -3., -3.],
           [ 0.,  0.,  0.,  0.],
           [ 0.,  0.,  0.,  0.]]]]))
```

---

```
attn_mask = attn_mask.masked_fill(attn_mask != 0, float(-100.0)).masked_fill(attn_mask == 0, float(0.0))
attn_mask.shape, attn_mask[..., 0]
```

```
(torch.Size([4, 4, 4, 4, 1]),
 tensor([[[[   0.,    0.,    0.,    0.],
           [   0.,    0.,    0.,    0.],
           [   0.,    0.,    0.,    0.],
           [   0.,    0.,    0.,    0.]],
 
          [[   0.,    0.,    0.,    0.],
           [   0.,    0.,    0.,    0.],
           [   0.,    0.,    0.,    0.],
           [   0.,    0.,    0.,    0.]],
 
          [[   0.,    0.,    0.,    0.],
           [   0.,    0.,    0.,    0.],
           [   0.,    0.,    0.,    0.],
           [   0.,    0.,    0.,    0.]],
 
          [[   0.,    0.,    0.,    0.],
           [   0.,    0.,    0.,    0.],
           [   0.,    0.,    0.,    0.],
           [   0.,    0.,    0.,    0.]]],
 
 
         [[[   0.,    0.,    0.,    0.],
           [   0.,    0.,    0.,    0.],
           [   0.,    0.,    0.,    0.],
           [   0.,    0.,    0.,    0.]],
 
          [[   0.,    0.,    0.,    0.],
           [   0.,    0.,    0.,    0.],
           [   0.,    0.,    0.,    0.],
           [   0.,    0.,    0.,    0.]],
 
          [[   0.,    0.,    0.,    0.],
           [   0.,    0.,    0.,    0.],
           [   0.,    0.,    0.,    0.],
           [   0.,    0.,    0.,    0.]],
 
          [[   0.,    0.,    0.,    0.],
           [   0.,    0.,    0.,    0.],
           [   0.,    0.,    0.,    0.],
           [   0.,    0.,    0.,    0.]]],
 
 
         [[[   0.,    0.,    0.,    0.],
           [   0.,    0.,    0.,    0.],
           [-100., -100., -100., -100.],
           [-100., -100., -100., -100.]],
 
          [[   0.,    0.,    0.,    0.],
           [   0.,    0.,    0.,    0.],
           [-100., -100., -100., -100.],
           [-100., -100., -100., -100.]],
 
          [[-100., -100., -100., -100.],
           [-100., -100., -100., -100.],
           [   0.,    0.,    0.,    0.],
           [   0.,    0.,    0.,    0.]],
 
          [[-100., -100., -100., -100.],
           [-100., -100., -100., -100.],
           [   0.,    0.,    0.,    0.],
           [   0.,    0.,    0.,    0.]]],
 
 
         [[[   0.,    0.,    0.,    0.],
           [   0.,    0.,    0.,    0.],
           [-100., -100., -100., -100.],
           [-100., -100., -100., -100.]],
 
          [[   0.,    0.,    0.,    0.],
           [   0.,    0.,    0.,    0.],
           [-100., -100., -100., -100.],
           [-100., -100., -100., -100.]],
 
          [[-100., -100., -100., -100.],
           [-100., -100., -100., -100.],
           [   0.,    0.,    0.,    0.],
           [   0.,    0.,    0.,    0.]],
 
          [[-100., -100., -100., -100.],
           [-100., -100., -100., -100.],
           [   0.,    0.,    0.,    0.],
           [   0.,    0.,    0.,    0.]]]]))
```

---

```
x = image.clone().permute(0, 2, 3, 1)  # (B, H, W, C)
B, H, W, C = x.shape
x[0, 0, 0, 0] = 0.  # 用于标记
x[0, -1, -1, -1] = 1.  # 用于标记
x.shape, x[..., 0], x[..., 1], x[..., 2]
```

```
(torch.Size([1, 8, 8, 3]),
 tensor([[[0.0000, 0.1060, 0.1015, 0.2196, 0.3544, 0.8485, 0.3509, 0.7353],
          [0.3751, 0.5690, 0.9630, 0.1945, 0.8999, 0.4977, 0.8007, 0.1598],
          [0.1991, 0.0081, 0.2861, 0.4539, 0.1620, 0.8776, 0.5298, 0.3748],
          [0.8627, 0.0345, 0.2435, 0.7224, 0.9310, 0.8621, 0.4113, 0.8057],
          [0.4686, 0.3372, 0.3429, 0.6660, 0.7115, 0.8560, 0.7055, 0.4709],
          [0.5104, 0.2789, 0.8015, 0.8737, 0.6784, 0.6677, 0.8233, 0.6589],
          [0.9013, 0.6980, 0.1548, 0.9066, 0.0334, 0.1617, 0.2747, 0.6150],
          [0.6927, 0.0394, 0.4180, 0.0387, 0.4488, 0.1339, 0.3340, 0.6178]]]),
 tensor([[[0.6409, 0.0384, 0.7775, 0.3550, 0.6754, 0.9210, 0.0923, 0.0691],
          [0.7684, 0.0422, 0.1605, 0.9409, 0.0397, 0.7786, 0.8475, 0.8495],
          [0.3684, 0.9283, 0.0569, 0.7790, 0.6074, 0.1229, 0.3138, 0.5926],
          [0.1865, 0.5766, 0.2497, 0.2391, 0.4254, 0.7249, 0.3116, 0.1666],
          [0.0800, 0.3956, 0.7351, 0.8919, 0.1177, 0.7949, 0.0028, 0.2635],
          [0.9967, 0.1205, 0.1785, 0.0886, 0.8664, 0.8412, 0.1258, 0.4302],
          [0.5620, 0.9326, 0.6767, 0.2432, 0.5963, 0.7276, 0.2273, 0.4879],
          [0.9367, 0.9096, 0.8327, 0.1795, 0.0361, 0.7189, 0.9292, 0.3822]]]),
 tensor([[[0.8273, 0.7008, 0.2891, 0.1136, 0.4981, 0.2119, 0.8096, 0.6342],
          [0.0062, 0.8495, 0.1382, 0.8667, 0.2436, 0.6408, 0.0238, 0.4742],
          [0.4363, 0.1852, 0.6110, 0.2923, 0.6231, 0.0668, 0.9430, 0.2830],
          [0.5139, 0.5424, 0.3008, 0.5251, 0.3518, 0.0882, 0.3335, 0.7853],
          [0.4835, 0.3571, 0.2530, 0.8452, 0.2010, 0.3866, 0.5673, 0.1172],
          [0.4750, 0.7820, 0.4262, 0.4426, 0.4161, 0.1199, 0.0477, 0.4646],
          [0.7525, 0.2686, 0.6829, 0.6753, 0.4345, 0.6609, 0.8414, 0.9140],
          [0.4540, 0.7455, 0.4464, 0.6749, 0.9152, 0.6936, 0.7035, 1.0000]]]))
```

---

```
# 可见标记 0.0000 和 1.0000 都在自身所在的 channel 里向左上角循环位移了 shift_size = window_size // 2 = 2 个 pixels
shifted_x = torch.roll(x, shifts=(-shift_size, -shift_size), dims=(1, 2))  # (B, H, W, C)
shifted_x.shape, shifted_x[..., 0], shifted_x[..., 1], shifted_x[..., 2]
```

```
(torch.Size([1, 8, 8, 3]),
 tensor([[[0.2861, 0.4539, 0.1620, 0.8776, 0.5298, 0.3748, 0.1991, 0.0081],
          [0.2435, 0.7224, 0.9310, 0.8621, 0.4113, 0.8057, 0.8627, 0.0345],
          [0.3429, 0.6660, 0.7115, 0.8560, 0.7055, 0.4709, 0.4686, 0.3372],
          [0.8015, 0.8737, 0.6784, 0.6677, 0.8233, 0.6589, 0.5104, 0.2789],
          [0.1548, 0.9066, 0.0334, 0.1617, 0.2747, 0.6150, 0.9013, 0.6980],
          [0.4180, 0.0387, 0.4488, 0.1339, 0.3340, 0.6178, 0.6927, 0.0394],
          [0.1015, 0.2196, 0.3544, 0.8485, 0.3509, 0.7353, 0.0000, 0.1060],
          [0.9630, 0.1945, 0.8999, 0.4977, 0.8007, 0.1598, 0.3751, 0.5690]]]),
 tensor([[[0.0569, 0.7790, 0.6074, 0.1229, 0.3138, 0.5926, 0.3684, 0.9283],
          [0.2497, 0.2391, 0.4254, 0.7249, 0.3116, 0.1666, 0.1865, 0.5766],
          [0.7351, 0.8919, 0.1177, 0.7949, 0.0028, 0.2635, 0.0800, 0.3956],
          [0.1785, 0.0886, 0.8664, 0.8412, 0.1258, 0.4302, 0.9967, 0.1205],
          [0.6767, 0.2432, 0.5963, 0.7276, 0.2273, 0.4879, 0.5620, 0.9326],
          [0.8327, 0.1795, 0.0361, 0.7189, 0.9292, 0.3822, 0.9367, 0.9096],
          [0.7775, 0.3550, 0.6754, 0.9210, 0.0923, 0.0691, 0.6409, 0.0384],
          [0.1605, 0.9409, 0.0397, 0.7786, 0.8475, 0.8495, 0.7684, 0.0422]]]),
 tensor([[[0.6110, 0.2923, 0.6231, 0.0668, 0.9430, 0.2830, 0.4363, 0.1852],
          [0.3008, 0.5251, 0.3518, 0.0882, 0.3335, 0.7853, 0.5139, 0.5424],
          [0.2530, 0.8452, 0.2010, 0.3866, 0.5673, 0.1172, 0.4835, 0.3571],
          [0.4262, 0.4426, 0.4161, 0.1199, 0.0477, 0.4646, 0.4750, 0.7820],
          [0.6829, 0.6753, 0.4345, 0.6609, 0.8414, 0.9140, 0.7525, 0.2686],
          [0.4464, 0.6749, 0.9152, 0.6936, 0.7035, 1.0000, 0.4540, 0.7455],
          [0.2891, 0.1136, 0.4981, 0.2119, 0.8096, 0.6342, 0.8273, 0.7008],
          [0.1382, 0.8667, 0.2436, 0.6408, 0.0238, 0.4742, 0.0062, 0.8495]]]))
```

---

```
x_windows = window_partition(shifted_x, window_size)  # (B*N, wh, ww, C) = (B*(H*W)//(wh*ww), wh, ww, C)
x_windows.shape, x_windows[..., 0], x_windows[..., 1], x_windows[..., 2]
```

```
(torch.Size([4, 4, 4, 3]),
 tensor([[[0.2861, 0.4539, 0.1620, 0.8776],
          [0.2435, 0.7224, 0.9310, 0.8621],
          [0.3429, 0.6660, 0.7115, 0.8560],
          [0.8015, 0.8737, 0.6784, 0.6677]],
 
         [[0.5298, 0.3748, 0.1991, 0.0081],
          [0.4113, 0.8057, 0.8627, 0.0345],
          [0.7055, 0.4709, 0.4686, 0.3372],
          [0.8233, 0.6589, 0.5104, 0.2789]],
 
         [[0.1548, 0.9066, 0.0334, 0.1617],
          [0.4180, 0.0387, 0.4488, 0.1339],
          [0.1015, 0.2196, 0.3544, 0.8485],
          [0.9630, 0.1945, 0.8999, 0.4977]],
 
         [[0.2747, 0.6150, 0.9013, 0.6980],
          [0.3340, 0.6178, 0.6927, 0.0394],
          [0.3509, 0.7353, 0.0000, 0.1060],
          [0.8007, 0.1598, 0.3751, 0.5690]]]),
 tensor([[[0.0569, 0.7790, 0.6074, 0.1229],
          [0.2497, 0.2391, 0.4254, 0.7249],
          [0.7351, 0.8919, 0.1177, 0.7949],
          [0.1785, 0.0886, 0.8664, 0.8412]],
 
         [[0.3138, 0.5926, 0.3684, 0.9283],
          [0.3116, 0.1666, 0.1865, 0.5766],
          [0.0028, 0.2635, 0.0800, 0.3956],
          [0.1258, 0.4302, 0.9967, 0.1205]],
 
         [[0.6767, 0.2432, 0.5963, 0.7276],
          [0.8327, 0.1795, 0.0361, 0.7189],
          [0.7775, 0.3550, 0.6754, 0.9210],
          [0.1605, 0.9409, 0.0397, 0.7786]],
 
         [[0.2273, 0.4879, 0.5620, 0.9326],
          [0.9292, 0.3822, 0.9367, 0.9096],
          [0.0923, 0.0691, 0.6409, 0.0384],
          [0.8475, 0.8495, 0.7684, 0.0422]]]),
 tensor([[[0.6110, 0.2923, 0.6231, 0.0668],
          [0.3008, 0.5251, 0.3518, 0.0882],
          [0.2530, 0.8452, 0.2010, 0.3866],
          [0.4262, 0.4426, 0.4161, 0.1199]],
 
         [[0.9430, 0.2830, 0.4363, 0.1852],
          [0.3335, 0.7853, 0.5139, 0.5424],
          [0.5673, 0.1172, 0.4835, 0.3571],
          [0.0477, 0.4646, 0.4750, 0.7820]],
 
         [[0.6829, 0.6753, 0.4345, 0.6609],
          [0.4464, 0.6749, 0.9152, 0.6936],
          [0.2891, 0.1136, 0.4981, 0.2119],
          [0.1382, 0.8667, 0.2436, 0.6408]],
 
         [[0.8414, 0.9140, 0.7525, 0.2686],
          [0.7035, 1.0000, 0.4540, 0.7455],
          [0.8096, 0.6342, 0.8273, 0.7008],
          [0.0238, 0.4742, 0.0062, 0.8495]]]))
```

---

```
x_windows = x_windows.view(-1, window_size * window_size, C)  # (B*N, wh*ww, C) = (B*(H*W)//(wh*ww), wh*ww, C)
x_windows.shape, x_windows[..., 0], x_windows[..., 1], x_windows[..., 2]
```

```
(torch.Size([4, 16, 3]),
 tensor([[0.2861, 0.4539, 0.1620, 0.8776, 0.2435, 0.7224, 0.9310, 0.8621, 0.3429,
          0.6660, 0.7115, 0.8560, 0.8015, 0.8737, 0.6784, 0.6677],
         [0.5298, 0.3748, 0.1991, 0.0081, 0.4113, 0.8057, 0.8627, 0.0345, 0.7055,
          0.4709, 0.4686, 0.3372, 0.8233, 0.6589, 0.5104, 0.2789],
         [0.1548, 0.9066, 0.0334, 0.1617, 0.4180, 0.0387, 0.4488, 0.1339, 0.1015,
          0.2196, 0.3544, 0.8485, 0.9630, 0.1945, 0.8999, 0.4977],
         [0.2747, 0.6150, 0.9013, 0.6980, 0.3340, 0.6178, 0.6927, 0.0394, 0.3509,
          0.7353, 0.0000, 0.1060, 0.8007, 0.1598, 0.3751, 0.5690]]),
 tensor([[0.0569, 0.7790, 0.6074, 0.1229, 0.2497, 0.2391, 0.4254, 0.7249, 0.7351,
          0.8919, 0.1177, 0.7949, 0.1785, 0.0886, 0.8664, 0.8412],
         [0.3138, 0.5926, 0.3684, 0.9283, 0.3116, 0.1666, 0.1865, 0.5766, 0.0028,
          0.2635, 0.0800, 0.3956, 0.1258, 0.4302, 0.9967, 0.1205],
         [0.6767, 0.2432, 0.5963, 0.7276, 0.8327, 0.1795, 0.0361, 0.7189, 0.7775,
          0.3550, 0.6754, 0.9210, 0.1605, 0.9409, 0.0397, 0.7786],
         [0.2273, 0.4879, 0.5620, 0.9326, 0.9292, 0.3822, 0.9367, 0.9096, 0.0923,
          0.0691, 0.6409, 0.0384, 0.8475, 0.8495, 0.7684, 0.0422]]),
 tensor([[0.6110, 0.2923, 0.6231, 0.0668, 0.3008, 0.5251, 0.3518, 0.0882, 0.2530,
          0.8452, 0.2010, 0.3866, 0.4262, 0.4426, 0.4161, 0.1199],
         [0.9430, 0.2830, 0.4363, 0.1852, 0.3335, 0.7853, 0.5139, 0.5424, 0.5673,
          0.1172, 0.4835, 0.3571, 0.0477, 0.4646, 0.4750, 0.7820],
         [0.6829, 0.6753, 0.4345, 0.6609, 0.4464, 0.6749, 0.9152, 0.6936, 0.2891,
          0.1136, 0.4981, 0.2119, 0.1382, 0.8667, 0.2436, 0.6408],
         [0.8414, 0.9140, 0.7525, 0.2686, 0.7035, 1.0000, 0.4540, 0.7455, 0.8096,
          0.6342, 0.8273, 0.7008, 0.0238, 0.4742, 0.0062, 0.8495]]))
```

---

```
# W-MSA/SW-MSA
#attn_windows = self.attn(x_windows, mask=self.attn_mask)  # 原操作 (B*N, wh*ww, C) = (B*(H*W)//(wh*ww), wh*ww, C)
attn_windows = x_windows.clone()  # 仅用于示范
 
# merge windows
attn_windows = attn_windows.view(-1, window_size, window_size, C)
attn_windows.shape
```

```
torch.Size([4, 4, 4, 3])
```

```
# reverse cyclic shift
shifted_x = window_reverse(attn_windows, window_size, H, W)
shifted_x.shape, shifted_x[..., 0], shifted_x[..., 1], shifted_x[..., 2]
```

```
(torch.Size([1, 8, 8, 3]),
 tensor([[[0.2861, 0.4539, 0.1620, 0.8776, 0.5298, 0.3748, 0.1991, 0.0081],
          [0.2435, 0.7224, 0.9310, 0.8621, 0.4113, 0.8057, 0.8627, 0.0345],
          [0.3429, 0.6660, 0.7115, 0.8560, 0.7055, 0.4709, 0.4686, 0.3372],
          [0.8015, 0.8737, 0.6784, 0.6677, 0.8233, 0.6589, 0.5104, 0.2789],
          [0.1548, 0.9066, 0.0334, 0.1617, 0.2747, 0.6150, 0.9013, 0.6980],
          [0.4180, 0.0387, 0.4488, 0.1339, 0.3340, 0.6178, 0.6927, 0.0394],
          [0.1015, 0.2196, 0.3544, 0.8485, 0.3509, 0.7353, 0.0000, 0.1060],
          [0.9630, 0.1945, 0.8999, 0.4977, 0.8007, 0.1598, 0.3751, 0.5690]]]),
 tensor([[[0.0569, 0.7790, 0.6074, 0.1229, 0.3138, 0.5926, 0.3684, 0.9283],
          [0.2497, 0.2391, 0.4254, 0.7249, 0.3116, 0.1666, 0.1865, 0.5766],
          [0.7351, 0.8919, 0.1177, 0.7949, 0.0028, 0.2635, 0.0800, 0.3956],
          [0.1785, 0.0886, 0.8664, 0.8412, 0.1258, 0.4302, 0.9967, 0.1205],
          [0.6767, 0.2432, 0.5963, 0.7276, 0.2273, 0.4879, 0.5620, 0.9326],
          [0.8327, 0.1795, 0.0361, 0.7189, 0.9292, 0.3822, 0.9367, 0.9096],
          [0.7775, 0.3550, 0.6754, 0.9210, 0.0923, 0.0691, 0.6409, 0.0384],
          [0.1605, 0.9409, 0.0397, 0.7786, 0.8475, 0.8495, 0.7684, 0.0422]]]),
 tensor([[[0.6110, 0.2923, 0.6231, 0.0668, 0.9430, 0.2830, 0.4363, 0.1852],
          [0.3008, 0.5251, 0.3518, 0.0882, 0.3335, 0.7853, 0.5139, 0.5424],
          [0.2530, 0.8452, 0.2010, 0.3866, 0.5673, 0.1172, 0.4835, 0.3571],
          [0.4262, 0.4426, 0.4161, 0.1199, 0.0477, 0.4646, 0.4750, 0.7820],
          [0.6829, 0.6753, 0.4345, 0.6609, 0.8414, 0.9140, 0.7525, 0.2686],
          [0.4464, 0.6749, 0.9152, 0.6936, 0.7035, 1.0000, 0.4540, 0.7455],
          [0.2891, 0.1136, 0.4981, 0.2119, 0.8096, 0.6342, 0.8273, 0.7008],
          [0.1382, 0.8667, 0.2436, 0.6408, 0.0238, 0.4742, 0.0062, 0.8495]]]))
```

---

```
# 可见标记 0.0000 和 1.0000 都在自身所在的 channel 里向右下角循环位移了 shift_size = window_size // 2 = 2 个 pixels 回去了
x = torch.roll(shifted_x, shifts=(shift_size, shift_size), dims=(1, 2))
x.shape, x[..., 0], x[..., 1], x[..., 2]
```

```
(torch.Size([1, 8, 8, 3]),
 tensor([[[0.0000, 0.1060, 0.1015, 0.2196, 0.3544, 0.8485, 0.3509, 0.7353],
          [0.3751, 0.5690, 0.9630, 0.1945, 0.8999, 0.4977, 0.8007, 0.1598],
          [0.1991, 0.0081, 0.2861, 0.4539, 0.1620, 0.8776, 0.5298, 0.3748],
          [0.8627, 0.0345, 0.2435, 0.7224, 0.9310, 0.8621, 0.4113, 0.8057],
          [0.4686, 0.3372, 0.3429, 0.6660, 0.7115, 0.8560, 0.7055, 0.4709],
          [0.5104, 0.2789, 0.8015, 0.8737, 0.6784, 0.6677, 0.8233, 0.6589],
          [0.9013, 0.6980, 0.1548, 0.9066, 0.0334, 0.1617, 0.2747, 0.6150],
          [0.6927, 0.0394, 0.4180, 0.0387, 0.4488, 0.1339, 0.3340, 0.6178]]]),
 tensor([[[0.6409, 0.0384, 0.7775, 0.3550, 0.6754, 0.9210, 0.0923, 0.0691],
          [0.7684, 0.0422, 0.1605, 0.9409, 0.0397, 0.7786, 0.8475, 0.8495],
          [0.3684, 0.9283, 0.0569, 0.7790, 0.6074, 0.1229, 0.3138, 0.5926],
          [0.1865, 0.5766, 0.2497, 0.2391, 0.4254, 0.7249, 0.3116, 0.1666],
          [0.0800, 0.3956, 0.7351, 0.8919, 0.1177, 0.7949, 0.0028, 0.2635],
          [0.9967, 0.1205, 0.1785, 0.0886, 0.8664, 0.8412, 0.1258, 0.4302],
          [0.5620, 0.9326, 0.6767, 0.2432, 0.5963, 0.7276, 0.2273, 0.4879],
          [0.9367, 0.9096, 0.8327, 0.1795, 0.0361, 0.7189, 0.9292, 0.3822]]]),
 tensor([[[0.8273, 0.7008, 0.2891, 0.1136, 0.4981, 0.2119, 0.8096, 0.6342],
          [0.0062, 0.8495, 0.1382, 0.8667, 0.2436, 0.6408, 0.0238, 0.4742],
          [0.4363, 0.1852, 0.6110, 0.2923, 0.6231, 0.0668, 0.9430, 0.2830],
          [0.5139, 0.5424, 0.3008, 0.5251, 0.3518, 0.0882, 0.3335, 0.7853],
          [0.4835, 0.3571, 0.2530, 0.8452, 0.2010, 0.3866, 0.5673, 0.1172],
          [0.4750, 0.7820, 0.4262, 0.4426, 0.4161, 0.1199, 0.0477, 0.4646],
          [0.7525, 0.2686, 0.6829, 0.6753, 0.4345, 0.6609, 0.8414, 0.9140],
          [0.4540, 0.7455, 0.4464, 0.6749, 0.9152, 0.6936, 0.7035, 1.0000]]]))
```

---

```
x = x.view(B, H * W, C)
x.shape
```

```
torch.Size([1, 64, 3])
```





